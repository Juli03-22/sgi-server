{% extends "base.html" %}
{% block content %}
<div class="flex flex-1 items-center justify-center p-4 min-h-screen bg-gray-50 dark:bg-gray-900">
    <div class="w-full max-w-2xl bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-8 space-y-6">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-2">Mi Perfil</h1>
        <form method="POST" action="{{ url_for('profile') }}" class="space-y-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Usuario</label>
                    <input type="text" id="username" name="username" value="{{ user['username'] }}" readonly class="block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 py-2 pl-3 pr-4 text-gray-900 dark:text-white"/>
                </div>
                <div>
                    <label for="role" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Rol</label>
                    <input type="text" id="role" name="role" value="{{ role_name }}" readonly class="block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 py-2 pl-3 pr-4 text-gray-900 dark:text-white"/>
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="nombres" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nombre(s)</label>
                    <input type="text" id="nombres" name="nombres" value="{{ user['nombres'] }}" class="block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 py-2 pl-3 pr-4 text-gray-900 dark:text-white"/>
                </div>
                <div>
                    <label for="apellido_paterno" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Apellido Paterno</label>
                    <input type="text" id="apellido_paterno" name="apellido_paterno" value="{{ user['apellido_paterno'] }}" class="block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 py-2 pl-3 pr-4 text-gray-900 dark:text-white"/>
                </div>
                <div>
                    <label for="apellido_materno" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Apellido Materno</label>
                    <input type="text" id="apellido_materno" name="apellido_materno" value="{{ user['apellido_materno'] }}" class="block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 py-2 pl-3 pr-4 text-gray-900 dark:text-white"/>
                </div>
                <div>
                    <label for="fecha_nacimiento" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Fecha de nacimiento</label>
                    <input type="date" id="fecha_nacimiento" name="fecha_nacimiento" value="{{ user['fecha_nacimiento'] }}" class="block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 py-2 pl-3 pr-4 text-gray-900 dark:text-white"/>
                </div>
            </div>
            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-green-500 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition">Guardar cambios</button>
        </form>
        <hr class="my-6 border-gray-300 dark:border-gray-600"/>
        <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">Seguridad</h2>
        <form method="POST" action="{{ url_for('change_password') }}" class="space-y-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="old_password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Contraseña actual</label>
                    <input type="password" id="old_password" name="old_password" class="block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 py-2 pl-3 pr-4 text-gray-900 dark:text-white"/>
                </div>
                <div>
                    <label for="new_password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nueva contraseña</label>
                    <input type="password" id="new_password" name="new_password" class="block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 py-2 pl-3 pr-4 text-gray-900 dark:text-white"/>
                </div>
            </div>
            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-600 transition">Cambiar contraseña</button>
        </form>
        <hr class="my-6 border-gray-300 dark:border-gray-600"/>
        <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">Métodos de Autenticación Multifactor (MFA)</h2>
        <div class="space-y-4">
            <div class="p-4 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
                <div class="flex items-center justify-between">
                    <div>
                        <span class="font-semibold">App autenticadora (TOTP/2FA):</span>
                        <span class="ml-2 font-semibold {{ 'text-green-600' if user['otp_secret'] else 'text-red-600' }}">{{ 'Activo' if user['otp_secret'] else 'Inactivo' }}</span>
                    </div>
                    <div class="flex gap-2">
                        {% if user['otp_secret'] %}
                            <form method="POST" action="{{ url_for('regenerate_2fa') }}">
                                <button type="submit" class="px-3 py-1 rounded bg-blue-500 hover:bg-blue-700 text-white text-xs">Regenerar</button>
                            </form>
                            <form method="POST" action="{{ url_for('delete_2fa') }}">
                                <button type="submit" class="px-3 py-1 rounded bg-red-500 hover:bg-red-700 text-white text-xs" {% if not webauthn_creds or webauthn_creds|length == 0 %}disabled class="opacity-50 cursor-not-allowed"{% endif %}>Eliminar</button>
                            </form>
                        {% else %}
                            <a href="{{ url_for('register_2fa') }}" class="px-3 py-1 rounded bg-green-500 hover:bg-green-700 text-white text-xs">Configurar</a>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="p-4 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
                <div class="flex items-center justify-between mb-2">
                    <div>
                        <span class="font-semibold">Llaves físicas (WebAuthn/Yubikey):</span>
                        <span class="ml-2 font-semibold {{ 'text-green-600' if webauthn_creds and webauthn_creds|length > 0 else 'text-red-600' }}">{{ webauthn_creds|length if webauthn_creds else 0 }} registradas</span>
                    </div>
                    <div>
                        <a href="{{ url_for('webauthn_register_page') }}" class="px-3 py-1 rounded bg-green-500 hover:bg-green-700 text-white text-xs">Agregar llave</a>
                    </div>
                </div>
                <ul class="space-y-2">
                    {% for key in webauthn_creds %}
                    <li class="flex items-center justify-between bg-white dark:bg-gray-800 rounded p-2 border border-gray-200 dark:border-gray-700">
                        <span class="text-xs">ID: {{ key['credential_id'][:12] }}... ({{ key['created_at'][:10] }})</span>
                        <form method="POST" action="{{ url_for('delete_webauthn_key', key_id=key['id']) }}">
                            <button type="submit" class="px-2 py-1 rounded bg-red-500 hover:bg-red-700 text-white text-xs" {% if (not user['otp_secret'] and webauthn_creds|length == 1) %}disabled class="opacity-50 cursor-not-allowed"{% endif %}>Eliminar</button>
                        </form>
                    </li>
                    {% else %}
                    <li class="text-xs text-gray-500">No tienes llaves físicas registradas.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}
